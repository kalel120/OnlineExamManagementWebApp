@model OnlineExamManagementWebApp.ViewModels.CourseEditViewModel


<br />
<ul class="nav nav-tabs">
    <li role="presentation" class="active"><a href="#basic-tab" data-toggle="tab">Basic Info</a></li>
    <li role="presentation"><a href="#assign-trainer" data-toggle="tab">Assign Trainer</a></li>
    <li role="presentation"><a href="#create-exams" data-toggle="tab">Create Exams</a></li>
</ul>

<div class="tab-content">
    <div id="basic-tab" class="tab-pane active">
        <br />
        @Html.HiddenFor(m => m.Id)
        @Html.HiddenFor(m => m.OrganizationId)
        <div class="form-group">
            @Html.LabelFor(m => m.OrganizationCode)
            @Html.TextBoxFor(m => m.OrganizationCode, new { @class = "form-control" })
        </div>
        <div class="form-group">
            @Html.LabelFor(m => m.Name)
            @Html.TextBoxFor(m => m.Name, new { @class = "form-control" })
        </div>
        <div class="form-group">
            @Html.LabelFor(m => m.Code)
            @Html.TextBoxFor(m => m.Code, new { @class = "form-control" })
        </div>
        <div class="form-group">
            @Html.LabelFor(m => m.Duration)
            @Html.TextBoxFor(m => m.Duration, new { @class = "form-control" })
        </div>
        <div class="form-group">
            @Html.LabelFor(m => m.Credit)
            @Html.TextBoxFor(m => m.Credit, new { @class = "form-control" })
        </div>
        <div class="form-group">
            @Html.LabelFor(m => m.Outline)
            @Html.TextBoxFor(m => m.Outline, new { @class = "form-control" })
        </div>
    </div>

    <div id="assign-trainer" class="tab-pane">
        @{
            Html.RenderPartial("_AssignTrainer");
            Html.RenderPartial("_EditTrainer");
        }
    </div>
    <div id="create-exams" class="tab-pane">

    </div>
</div>

@section scripts {
    <script src="~/Scripts/select2.js"></script>

    <script type="text/javascript">
        $(function () {
            var organizationId = $('#OrganizationId').val();
            var courseId = $('#Id').val();

            // This empty array will contain list of new trainers to be added in html table
            var trainers = new Array();

            function clearCheckBox() {
                $('#is-lead').prop('checked', false);
            }


            $('#js-ddl-trainers').select2({
                placeholder: "--Select Trainer--",
                ajax: {
                    url: "/Course/GetTrainers",
                    dataType: "json",
                    data: function (params) {
                        var query = {
                            searchTerm: params.term,
                            orgId: organizationId
                        }
                        return query;
                    },
                    processResults: function (data, params) {
                        return {
                            results: data
                        };
                    }
                }
            });

            // Load assigned trainer from database in assigned trainer tab            
            loadTrainersById(courseId);

            function loadTrainersById(courseId) {
                $.ajax({
                    url: "/Course/GetTrainersByCourse/" + courseId,
                    type: "GET",
                    contentType: 'application/json',
                    success: function (result) {
                        var html = '';

                        $.each(result, function (key, item) {
                            var rbValue = '<td><input type="radio" name="IsLead" disabled="disabled"/> </td>';
                            if (item.IsLead) {
                                rbValue = '<td><input type="radio" name="IsLead" disabled="disabled" checked/> </td>';
                            }

                            html += '<tr>';
                            html += "<td><input type=hidden value='" + item.TrainerId + "'/>";
                            html += item.TrainerName + '</td>';
                            html += rbValue;
                            html += "<td> <a href='#' class='js-toggle-lead'> Edit |</a>";
                            html += "<a href='#' class='js-remove-trainer'> Remove </a></td>";
                            html += '</tr>';
                        });

                        $('#table-body').html(html);
                    },

                    error: function (message) {
                        alert('Something is wrong!');
                    }
                });
            }

            function isTrainerAlreadyExists(selectedTrainerId) {
                var isDuplicatedTrainer = false;
                $("#table-body").find('tr').each(function () {
                    var td = $(this).find('input[type="hidden"]').val();

                    if (td === selectedTrainerId) {
                        alert("already exists");
                        isDuplicatedTrainer = true;
                        return false;
                    }

                });
                return isDuplicatedTrainer;
            }

            function isLeadTrainerExists(isLeadCheckBoxChecked) {
                if (($("input[name='IsLead']:checked").val()) && isLeadCheckBoxChecked) {
                    alert('Lead already defined');
                    clearCheckBox();
                    return true;
                }

                return false;
            }

            $('#js-insert-table').click(function () {
                var selectedTrainerId = $('#js-ddl-trainers').val();
                var selectedTrainerName = $('#js-ddl-trainers').children("option").filter(":selected").text();

                if (selectedTrainerId == null) {
                    alert("Select a trainer to assign");
                    return false;
                }

                if (isTrainerAlreadyExists(selectedTrainerId)) {
                    return false;
                }

                var isLeadCheckBoxChecked = $('#is-lead').prop('checked');
                if (isLeadTrainerExists(isLeadCheckBoxChecked)) {
                    return false;
                }

                // Building htmlTable;
                var tr = "<tr>";
                var tdTrainerName = "<td><input type='hidden' value='" + selectedTrainerId + "'/>";
                tdTrainerName += selectedTrainerName;
                tdTrainerName += "</td>";

                var rbValue = '<td><input type="radio" name="IsLead" disabled="disabled"/> </td>';
                if (isLeadCheckBoxChecked) {
                    rbValue = '<td><input type="radio" name="IsLead" disabled="disabled" checked/> </td>';
                }

                var tdAction = "<td> <a href='#' class='js-toggle-lead' > Edit |</a>";
                tdAction += "<a href='#' class='js-remove-trainer' '> Remove </a>";
                tdAction += "</td>";

                tr += tdTrainerName + rbValue + tdAction + "</tr>";

                $('#table-body').append(tr);


                var assignVm = {
                    CourseId: courseId,
                    TrainerName: selectedTrainerName,
                    TrainerId: selectedTrainerId,
                    IsLead: isLeadCheckBoxChecked
                }
                trainers.push(assignVm);

                clearCheckBox();
            });


            // Save to database functionality
            $('#js-save-trainers').click(function () {
                if (!trainers || trainers.length === 0) {
                    alert('alredy exists');
                    return;
                }

                if (!confirm('Are you sure you want to assign?')) {
                    return;
                }

                $.ajax({
                    url: "/Course/AssignTrainer",
                    type: "POST",
                    contentType: 'application/json',
                    dataType: 'json',
                    data: JSON.stringify(trainers),                    
                    success: function () {                        
                        trainers.length = 0;
                        loadTrainersById(courseId);
                        alert("Assigned Trainers Successfully");
                    },
                    error: function (message) {
                        alert(message.responseText);
                    }
                });
            });

            // Remove trainer from html table
            $(document).on('click', '.js-remove-trainer', function () {
                var closestRow = $(this).closest("tr");
                var trainerId = closestRow.find("input[type='hidden']").val();
                var trainerName = closestRow.find('td:eq(0)').text();

                if (confirm("Are you sure you want to delete?")) {
                    $.ajax({
                        url: '/Course/UnassignTrainer',
                        type: "POST",
                        contentType: 'application/json',
                        dataType: "json",                        
                        data: JSON.stringify({
                            CourseId: courseId,
                            TrainerId: trainerId
                        }),
                        success: function () {
                            closestRow.remove();
                            alert(trainerName + " is unassigned");
                        },
                        error: function (message) {
                            console.log(message.responseText);
                        }
                    });
                }
            });

            $(document).on('click', '.js-toggle-lead',function(event) {                
                $("#js-toggle-lead-modal").modal("toggle");
                var editLink = $(event.target).closest("tr");
                
                $("#js-p-trainerName").text(editLink.find("td:eq(0)").text());

            });

            // jQuery function ends here //
        });
    </script>
}
